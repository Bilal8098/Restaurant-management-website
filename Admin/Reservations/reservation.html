<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head><body>
    <h1>Table Reservations Calendar</h1>
    <div class="calendar-container">
        <div class="calendar-controls">
            <button id="prev-week">â—€ Previous</button>
            <span id="week-range"></span>
            <button id="next-week">Next â–¶</button>
        </div>
        <table class="calendar-table">
            <thead>
                <tr id="calendar-header"></tr>
            </thead>
            <tbody id="calendar-body"></tbody>
        </table>
    </div>
    <script>
        // helper to pad numbers to two digits
        function pad(n){ return n < 10 ? '0'+n : ''+n; }
      
        // YYYY-MM-DD from a local Date
        function ymd(d){
          return d.getFullYear() + '-' +
                 pad(d.getMonth() + 1) + '-' +
                 pad(d.getDate());
        }
      
        // find Monday (or shift Sunday) and return local-midnight Date
        function getStartOfWeek(date){
          const d   = new Date(date);
          const day = d.getDay();
          const diff= d.getDate() - day + (day===0 ? -6 : 1);
          const m   = new Date(d.setDate(diff));
          return new Date(m.getFullYear(), m.getMonth(), m.getDate());
        }
      
        let currentWeekStart = getStartOfWeek(new Date());
        const refreshInterval = setInterval(loadCalendar, 5000);
      
        async function fetchReservations(){
          try {
            let r = await fetch('http://127.0.0.1:5000/reservations', { mode:'cors' });
            let j = await r.json();
            return (j.data||[]).map(r=>({
              ReservationID: r.reservationid,
              UserID:        r.userid,
              TableID:       r.tableid,
              startDate:     r.startdate,
              endDate:       r.enddate,
              Name:          r.name,
              PhoneNumber:   r.phonenumber,
              Status:        r.status
            }));
          } catch(e){
            console.error('fetchReservations',e);
            return [];
          }
        }
      
        async function fetchTables(){
          try {
            let r = await fetch('http://127.0.0.1:5000/get_tables', { mode:'cors' });
            let j = await r.json();
            return (j.tables||[]).map(t=>({ TableID: t.TableID }));
          } catch(e){
            console.error('fetchTables',e);
            return [];
          }
        }
      
        function processReservations(reservations, tables, weekStart){
          const grouped = {};
          tables.forEach(t=>{
            grouped[t.TableID] = {};
            for(let i=0;i<7;i++){
              const day = new Date(
                weekStart.getFullYear(),
                weekStart.getMonth(),
                weekStart.getDate()+i
              );
              grouped[t.TableID][ ymd(day) ] = [];
            }
          });
      
          reservations.forEach(r => {
            const s = new Date(r.startDate), e = new Date(r.endDate);
            if(s>=e) return;
      
            let cur = new Date(s.getFullYear(), s.getMonth(), s.getDate());
            const last = new Date(e.getFullYear(), e.getMonth(), e.getDate());
      
            while(cur <= last){
              const key = ymd(cur);
              if(grouped[r.TableID] && grouped[r.TableID][key]){
                grouped[r.TableID][key].push(r);
              }
              cur.setDate(cur.getDate()+1);
            }
          });
      
          return grouped;
        }
      
        function renderCalendar(weekStart, grouped, tables){
          // build the 7 days
          const days = [];
          for(let i=0;i<7;i++){
            days.push(new Date(
              weekStart.getFullYear(),
              weekStart.getMonth(),
              weekStart.getDate()+i
            ));
          }
      
          // render header
          document.getElementById('calendar-header').innerHTML =
            '<th>Table</th>' +
            days.map(d=>
              `<th>${d.toLocaleDateString('en-US',{weekday:'short'})}<br>${d.getDate()}</th>`
            ).join('');
      
          // render body
          const tbody = document.getElementById('calendar-body');
          tbody.innerHTML = '';
      
          tables.sort((a,b)=>a.TableID-b.TableID)
                .forEach(t => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>Table ${t.TableID}</td>`;
      
            days.forEach(d => {
              const cell = document.createElement('td');
              let list = (grouped[t.TableID]||{})[ymd(d)] || [];
      
              // sort by start time:
              list.sort((a,b)=> new Date(a.startDate) - new Date(b.startDate));
      
              // if you want to cap visible items, you could slice() here
      
              list.forEach((r, idx, arr) => {
                const start = new Date(r.startDate)
                                .toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                const end   = new Date(r.endDate)
                                .toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                const slot  = document.createElement('div');
      
                slot.className = 'reservation-item';
                // side-by-side layout:
                slot.style.display      = 'inline-block';
                slot.style.verticalAlign= 'top';
                slot.style.width        = `${100/arr.length}%`;
                slot.style.boxSizing    = 'border-box';
                slot.style.padding      = '4px';
                slot.style.margin       = '2px 0';
      
                slot.innerHTML = `
                  <div>ðŸ•’ ${start} - ${end}</div>
                  <div>ðŸ‘¤ ${r.Name||'â€”'}</div>
                  <div>ðŸ“ž ${r.PhoneNumber||'â€”'}</div>
                  <div>ðŸŸ¢ ${r.Status}</div>
                `;
                cell.appendChild(slot);
              });
      
              tr.appendChild(cell);
            });
      
            tbody.appendChild(tr);
          });
        }
      
        function updateWeekRange(){
          const end = new Date(
            currentWeekStart.getFullYear(),
            currentWeekStart.getMonth(),
            currentWeekStart.getDate()+6
          );
          document.getElementById('week-range').textContent =
            `${currentWeekStart.toLocaleDateString()} â€” ${end.toLocaleDateString()}`;
        }
      
        document.getElementById('prev-week').onclick = ()=>{
          currentWeekStart.setDate(currentWeekStart.getDate()-7);
          loadCalendar();
        };
        document.getElementById('next-week').onclick = ()=>{
          currentWeekStart.setDate(currentWeekStart.getDate()+7);
          loadCalendar();
        };
      
        async function loadCalendar(){
          updateWeekRange();
          const [ reservations, tables ] = await Promise.all([
            fetchReservations(),
            fetchTables()
          ]);
          const grouped = processReservations(reservations, tables, currentWeekStart);
          renderCalendar(currentWeekStart, grouped, tables);
        }
      
        // initial draw
        loadCalendar();
        window.addEventListener('beforeunload', ()=>clearInterval(refreshInterval));
      </script>
      
      
</body>
</html>